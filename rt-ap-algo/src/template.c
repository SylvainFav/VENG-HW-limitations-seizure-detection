
#include <stdio.h>
#include <stddef.h>
#include <stdlib.h>
#include <stdint.h>

#include "../include/setup.h"
#include "../include/template.h"


// Spike templates, normalized in amplitude
// Hard-coded for speed
static float initial_templates[N_INIT_TEMPLATES][SPIKE_SIZE] = {{0.00000, 0.000000, 0.014420, 0.068380, 0.161688, 0.271739, 0.380870, 0.453089, 0.437813, 0.337330, 0.198499, 0.057441, -0.056937, -0.118861, -0.132355, -0.123285, -0.110800, -0.102314, -0.097986, -0.095754, -0.093946, -0.091862, -0.089444, -0.086856, -0.084244, -0.081678, -0.079166, -0.076699, -0.074264, -0.071858, -0.069480, -0.067132, -0.064817, -0.062535, -0.060288, -0.058077, -0.055902, -0.053764, -0.051664, -0.049601},
{0.000000, 0.000000, 0.008905, 0.042228, 0.099851, 0.167813, 0.235207, 0.297616, 0.354829, 0.390211, 0.373754, 0.306185, 0.215539, 0.123613, 0.039222, -0.037185, -0.098995, -0.132661, -0.139210, -0.132764, -0.124128, -0.117625, -0.113455, -0.110501, -0.107823, -0.105016, -0.102040, -0.098984, -0.095931, -0.092921, -0.089961, -0.087047, -0.084172, -0.081335, -0.078536, -0.075777, -0.073059, -0.070384, -0.067753, -0.065167},
{0.000000, 0.000000, 0.000000, 0.006328, 0.030010, 0.070960, 0.119258, 0.167153, 0.211504, 0.252163, 0.289964, 0.325632, 0.346857, 0.331672, 0.280232, 0.212365, 0.143595, 0.080240, 0.022651, -0.030791, -0.081489, -0.123762, -0.146706, -0.150335, -0.144500, -0.136951, -0.130864, -0.126449, -0.122931, -0.119640, -0.116279, -0.112815, -0.109310, -0.105823, -0.102385, -0.099002, -0.095670, -0.092386, -0.089150, -0.085961},
{0.000000, 0.000000, 0.000000, 0.004878, 0.023132, 0.054696, 0.091925, 0.128842, 0.163028, 0.194368, 0.223506, 0.250999, 0.277115, 0.301918, 0.315641, 0.301278, 0.258975, 0.204056, 0.148513, 0.097221, 0.050449, 0.006944, -0.034375, -0.074012, -0.112059, -0.143584, -0.160038, -0.161481, -0.155594, -0.148398, -0.142359, -0.137635, -0.133623, -0.129803, -0.125945, -0.122025, -0.118090, -0.114188, -0.110343, -0.106560},
{0.000000, 0.000000, 0.013899, 0.065739, 0.153933, 0.253329, 0.343272, 0.387403, 0.337912, 0.201630, 0.032338, -0.126512, -0.242854, -0.292639, -0.284265, -0.249230, -0.211767, -0.181802, -0.159479, -0.141511, -0.125068, -0.108893, -0.092918, -0.077538, -0.063126, -0.049868, -0.037791, -0.026845, -0.016968, -0.008108, -0.000223, 0.006724, 0.012775, 0.017974, 0.022373, 0.026024, 0.028983, 0.031303, 0.033039, 0.034243},
{0.000000, 0.000000, 0.008928, 0.042227, 0.098878, 0.162725, 0.220499, 0.266702, 0.301511, 0.309416, 0.261767, 0.161978, 0.043031, -0.068180, -0.160335, -0.233394, -0.282675, -0.296736, -0.278904, -0.246269, -0.212443, -0.183236, -0.158950, -0.137863, -0.118419, -0.099907, -0.082269, -0.065710, -0.050424, -0.036499, -0.023930, -0.012665, -0.002639, 0.006211, 0.013944, 0.020615, 0.026286, 0.031020, 0.034882, 0.037938},
{0.000000, 0.000000, 0.000000, 0.006579, 0.031118, 0.072865, 0.119915, 0.162490, 0.196538, 0.222189, 0.241173, 0.255137, 0.251937, 0.209304, 0.129007, 0.035092, -0.052595, -0.125618, -0.183892, -0.230551, -0.268588, -0.293180, -0.293687, -0.271161, -0.237780, -0.203711, -0.173507, -0.147577, -0.124715, -0.103763, -0.084154, -0.065806, -0.048840, -0.033374, -0.019450, -0.007036, 0.003934, 0.013541, 0.021864, 0.028977},
{0.000000, 0.000000, 0.000000, 0.005247, 0.024815, 0.058106, 0.095626, 0.129578, 0.156729, 0.177184, 0.192323, 0.203459, 0.211400, 0.216540, 0.208596, 0.169606, 0.101001, 0.022032, -0.051431, -0.112664, -0.161636, -0.200890, -0.232853, -0.258965, -0.279850, -0.290532, -0.282181, -0.255741, -0.221132, -0.186610, -0.155852, -0.129168, -0.105559, -0.084061, -0.064192, -0.045862, -0.029139, -0.014091, -0.000721, 0.011027},
{0.000000, 0.000000, 0.013376, 0.063080, 0.146153, 0.235040, 0.306448, 0.324334, 0.244735, 0.080210, -0.107749, -0.268344, -0.367380, -0.384573, -0.335164, -0.258384, -0.184755, -0.126901, -0.084361, -0.051755, -0.024389, -0.000114, 0.021211, 0.038960, 0.052653, 0.062282, 0.068234, 0.071075, 0.071379, 0.069650, 0.066314, 0.061740, 0.056261, 0.050182, 0.043777, 0.037284, 0.030903, 0.024794, 0.019081, 0.013853},
{0.000000, 0.000000, 0.009010, 0.042491, 0.098448, 0.158323, 0.206423, 0.236491, 0.249835, 0.232905, 0.159084, 0.035194, -0.100140, -0.214715, -0.295345, -0.343909, -0.359535, -0.334601, -0.276129, -0.205202, -0.138812, -0.084337, -0.041827, -0.008370, 0.018790, 0.041133, 0.059080, 0.072632, 0.081858, 0.087076, 0.088810, 0.087671, 0.084257, 0.079101, 0.072669, 0.065363, 0.057534, 0.049488, 0.041489, 0.033752},
{0.000000, 0.000000, 0.000000, 0.007017, 0.033089, 0.076666, 0.123293, 0.160751, 0.184166, 0.194557, 0.195407, 0.190064, 0.166705, 0.102423, 0.000962, -0.108251, -0.200203, -0.264520, -0.302643, -0.321035, -0.326016, -0.314722, -0.277290, -0.216455, -0.147676, -0.084335, -0.032608, 0.007246, 0.037595, 0.060902, 0.078706, 0.091698, 0.100184, 0.104471, 0.105026, 0.102454, 0.097409, 0.090515, 0.082320, 0.073295},
{0.000000, 0.000000, 0.000000, 0.005989, 0.028241, 0.065433, 0.105228, 0.137198, 0.157183, 0.166052, 0.166776, 0.162217, 0.154258, 0.143899, 0.119710, 0.061583, -0.027340, -0.121855, -0.200594, -0.254811, -0.285919, -0.299637, -0.301539, -0.295315, -0.282934, -0.259511, -0.215700, -0.153882, -0.087556, -0.028275, 0.018823, 0.053837, 0.079163, 0.097254, 0.109720, 0.117393, 0.120745, 0.120222, 0.116388, 0.109901}};

int template_init(algo_t* algo) {

    algo->ntemplates = N_INIT_TEMPLATES;
    algo->templates = (template_t**) malloc(algo->ntemplates * sizeof(template_t*));
    for (uint8_t i=0; i<algo->ntemplates; i++) {
        algo->templates[i] = (template_t*) malloc(sizeof(template_t));
        algo->templates[i]->values = (float*) malloc(SPIKE_SIZE * sizeof(float));
        for (uint32_t j=0; j<SPIKE_SIZE; j++) {
            algo->templates[i]->values[j] = initial_templates[i][j];
        }
        algo->templates[i]->nspikes = 0;
    }

    return 0;
}

int sort_templates(algo_t* algo) {
    
    uint32_t template_min_nspikes = round(TEMPLATE_SORT_MIN_NSPIKES_REL * algo->nspikes_cumulated);

    // Find templates that should be kept
    uint8_t* keep_templates = (uint8_t*) malloc(algo->ntemplates * sizeof(uint8_t));
    uint8_t keep_ntemplates = 0;
    for (uint8_t i=0; i<algo->ntemplates; i++) {
        if (algo->templates[i]->nspikes > template_min_nspikes) {
            keep_templates[i] = 1;
            keep_ntemplates++;
        }
        else {
            keep_templates[i] = 0;
        }
    }

    // Update template list
    template_t** new_templates = (template_t**) malloc(keep_ntemplates * sizeof(template_t*));
    uint8_t inew = 0;
    for (uint8_t i=0; i<algo->ntemplates; i++) {
        if (keep_templates[i] == 1) {
            new_templates[inew++] = algo->templates[i];
        }
        else {
            if (algo->templates[i] != NULL) {
                if (algo->templates[i]->values != NULL) {
                    free(algo->templates[i]->values);
                    algo->templates[i]->values = NULL;
                }
                free(algo->templates[i]);
                algo->templates[i] = NULL;
            }
        }
    }
    algo->templates = new_templates;
    algo->ntemplates = keep_ntemplates;

    free(keep_templates);

    return 0;
}

int template_free(algo_t* algo) {

    if (algo->templates != NULL) {
        for (uint8_t i=0; i<algo->ntemplates; i++) {
            if (algo->templates[i] != NULL) {
                if (algo->templates[i]->values != NULL) {
                    free(algo->templates[i]->values);
                    algo->templates[i]->values = NULL;
                }
                free(algo->templates[i]);
                algo->templates[i] = NULL;
            }
        }
        free(algo->templates);
        algo->templates = NULL;
    }

    return 0;
}

